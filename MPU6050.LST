C51 COMPILER V9.54   MPU6050                                                               03/13/2018 22:04:48 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MPU6050
OBJECT MODULE PLACED IN MPU6050.OBJ
COMPILER INVOKED BY: E:\KeilC51\C51\BIN\C51.EXE MPU6050.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          //ï»¿***************************************
   2          // Update to MPU6050 by shinetop
   3          // MCU: STC89C52
   4          // 2012.3.1
   5          // åŠŸèƒ½: æ˜¾ç¤ºåŠ é€Ÿåº¦è®¡å’Œé™€èºä»ªçš„10ä½åŸå§‹æ•°æ®
   6          //****************************************
   7          // GY-52 MPU3050 IICæµ‹è¯•ç¨‹åº
   8          // ä½¿ç”¨å•ç‰‡æœºSTC89C51
   9          // æ™¶æŒ¯ï¼š11.0592M
  10          // æ˜¾ç¤ºï¼šLCD1602
  11          // ç¼–è¯‘ç¯å¢ƒ Keil uVision2
  12          // å‚è€ƒå®æ™¶ç½‘ç«™24c04é€šä¿¡ç¨‹åº
  13          // æ—¶é—´ï¼š2011å¹´9æœˆ1æ—¥
  14          // QQï¼š531389319
  15          //****************************************
  16          #include <REG52.H>
  17          #include <math.h>    //Keil library
  18          #include <stdio.h>   //Keil library
  19          #include <INTRINS.H>
  20          typedef unsigned char  uchar;
  21          typedef unsigned short ushort;
  22          typedef unsigned int   uint;
  23          //****************************************
  24          // å®šä¹‰51å•ç‰‡æœºç«¯å£
  25          //****************************************
  26          #define DataPort P0   //LCD1602æ•°æ®ç«¯å£
  27          sbit    SCL=P0^0;     //IICæ—¶é’Ÿå¼•è„šå®šä¹‰
  28          sbit    SDA=P0^1;     //IICæ•°æ®å¼•è„šå®šä¹‰
  29          sbit    LCM_RS=P2^0;    //LCD1602å‘½ä»¤ç«¯å£
  30          sbit    LCM_RW=P2^1;    //LCD1602å‘½ä»¤ç«¯å£
  31          sbit    LCM_EN=P2^2;    //LCD1602å‘½ä»¤ç«¯å£
  32          //****************************************
  33          // å®šä¹‰MPU6050å†…éƒ¨åœ°å€
  34          //****************************************
  35          #define SMPLRT_DIV    0x19  //é™€èºä»ªé‡‡æ ·ç‡ï¼Œå…¸å‹å€¼ï¼š0x07(125Hz)
  36          #define CONFIG      0x1A  //ä½é€šæ»¤æ³¢é¢‘ç‡ï¼Œå…¸å‹å€¼ï¼š0x06(5Hz)
  37          #define GYRO_CONFIG   0x1B  //é™€èºä»ªè‡ªæ£€åŠæµ‹é‡èŒƒå›´ï¼Œå…¸å‹å€¼ï¼š0x18(ä¸è‡ªæ£€ï¼Œ2000deg/s)
  38          #define ACCEL_CONFIG  0x1C  //åŠ é€Ÿè®¡è‡ªæ£€ã€æµ‹é‡èŒƒå›´åŠé«˜é€šæ»¤æ³¢é¢‘ç‡ï¼Œå…¸å‹å€¼ï¼š0x01(ä¸è‡ªæ
             -£€ï¼Œ2Gï¼Œ5Hz)
  39          #define ACCEL_XOUT_H  0x3B
  40          #define ACCEL_XOUT_L  0x3C
  41          #define ACCEL_YOUT_H  0x3D
  42          #define ACCEL_YOUT_L  0x3E
  43          #define ACCEL_ZOUT_H  0x3F
  44          #define ACCEL_ZOUT_L  0x40
  45          #define TEMP_OUT_H    0x41
  46          #define TEMP_OUT_L    0x42
  47          #define GYRO_XOUT_H   0x43
  48          #define GYRO_XOUT_L   0x44
  49          #define GYRO_YOUT_H   0x45
  50          #define GYRO_YOUT_L   0x46
  51          #define GYRO_ZOUT_H   0x47
  52          #define GYRO_ZOUT_L   0x48
  53          #define PWR_MGMT_1    0x6B  //ç”µæºç®¡ç†ï¼Œå…¸å‹å€¼ï¼š0x00(æ­£å¸¸å¯ç”¨)
  54          #define WHO_AM_I    0x75  //IICåœ°å€å¯„å­˜å™¨(é»˜è®¤æ•°å€¼0x68ï¼Œåªè¯»)
C51 COMPILER V9.54   MPU6050                                                               03/13/2018 22:04:48 PAGE 2   

  55          #define SlaveAddress  0xD0  //IICå†™å…¥æ—¶çš„åœ°å€å­—èŠ‚æ•°æ®ï¼Œ+1ä¸ºè¯»å–
  56          //****************************************
  57          //å®šä¹‰ç±»å‹åŠå˜é‡
  58          //****************************************
  59          uchar dis[6];             //æ˜¾ç¤ºæ•°å­—(-511è‡³512)çš„å­—ç¬¦æ•°ç»„
  60          int dis_data;           //å˜é‡
  61          //int Temperature,Temp_h,Temp_l;  //æ¸©åº¦åŠé«˜ä½ä½æ•°æ®
  62          //****************************************
  63          //å‡½æ•°å£°æ˜
  64          //****************************************
  65          void  delay(unsigned int k);                    //å»¶æ—¶
  66          void  lcd_printf(uchar *s,int temp_data);
  67          
  68          //MPU6050æ“ä½œå‡½æ•°
  69          void  InitMPU6050();                          //åˆå§‹åŒ–MPU6050
  70          void  Delay5us();
  71          void  I2C_Start();
  72          void  I2C_Stop();
  73          void  I2C_SendACK(bit ack);
  74          bit   I2C_RecvACK();
  75          void  I2C_SendByte(uchar dat);
  76          uchar I2C_RecvByte();
  77          void  I2C_ReadPage();
  78          void  I2C_WritePage();
  79          void  display_ACCEL_x();
  80          void  display_ACCEL_y();
  81          void  display_ACCEL_z();
  82          uchar Single_ReadI2C(uchar REG_Address);            //è¯»å–I2Cæ•°æ®
  83          void  Single_WriteI2C(uchar REG_Address,uchar REG_data);  //å‘I2Cå†™å…¥æ•°æ®
  84          //****************************************
  85          //æ•´æ•°è½¬å­—ç¬¦ä¸²
  86          //****************************************
  87          void lcd_printf(uchar *s,int temp_data)
  88          {
  89   1        if(temp_data<0)
  90   1        {
  91   2          temp_data=-temp_data;
  92   2          *s='-';
  93   2        }
  94   1        else *s=' ';
  95   1      
  96   1        *++s =temp_data/10000+0x30;
  97   1        temp_data=temp_data%10000;     //å–ä½™è¿ç®—
  98   1      
  99   1        *++s =temp_data/1000+0x30;
 100   1        temp_data=temp_data%1000;     //å–ä½™è¿ç®—
 101   1      
 102   1        *++s =temp_data/100+0x30;
 103   1        temp_data=temp_data%100;     //å–ä½™è¿ç®—
 104   1        *++s =temp_data/10+0x30;
 105   1        temp_data=temp_data%10;      //å–ä½™è¿ç®—
 106   1        *++s =temp_data+0x30;
 107   1      }
 108          //****************************************
 109          
 110          void  SeriPushSend(uchar send_data)
 111          {
 112   1          SBUF=send_data;
 113   1        while(!TI);TI=0;
 114   1      }
 115          //****************************************
 116          //å»¶æ—¶
C51 COMPILER V9.54   MPU6050                                                               03/13/2018 22:04:48 PAGE 3   

 117          //****************************************
 118          void delay(unsigned int k)
 119          {
 120   1        unsigned int i,j;
 121   1        for(i=0;i<k;i++)
 122   1        {
 123   2          for(j=0;j<121;j++);
 124   2        }
 125   1      }
 126          
 127          //**************************************
 128          //å»¶æ—¶5å¾®ç§’(STC90C52RC@12M)
 129          //ä¸åŒçš„å·¥ä½œç¯å¢ƒ,éœ€è¦è°ƒæ•´æ­¤å‡½æ•°
 130          //å½“æ”¹ç”¨1Tçš„MCUæ—¶,è¯·è°ƒæ•´æ­¤å»¶æ—¶å‡½æ•°
 131          //**************************************
 132          void Delay5us()
 133          {
 134   1        _nop_();_nop_();_nop_();_nop_();
 135   1        _nop_();_nop_();_nop_();_nop_();
 136   1        _nop_();_nop_();_nop_();_nop_();
 137   1        _nop_();_nop_();_nop_();_nop_();
 138   1        _nop_();_nop_();_nop_();_nop_();
 139   1        _nop_();_nop_();_nop_();_nop_();
 140   1      }
 141          //**************************************
 142          //I2Cèµ·å§‹ä¿¡å·
 143          //**************************************
 144          void I2C_Start()
 145          {
 146   1          SDA = 1;                    //æ‹‰é«˜æ•°æ®çº¿
 147   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 148   1          Delay5us();                 //å»¶æ—¶
 149   1          SDA = 0;                    //äº§ç”Ÿä¸‹é™æ²¿
 150   1          Delay5us();                 //å»¶æ—¶
 151   1          SCL = 0;                    //æ‹‰ä½æ—¶é’Ÿçº¿
 152   1      }
 153          //**************************************
 154          //I2Cåœæ­¢ä¿¡å·
 155          //**************************************
 156          void I2C_Stop()
 157          {
 158   1          SDA = 0;                    //æ‹‰ä½æ•°æ®çº¿
 159   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 160   1          Delay5us();                 //å»¶æ—¶
 161   1          SDA = 1;                    //äº§ç”Ÿä¸Šå‡æ²¿
 162   1          Delay5us();                 //å»¶æ—¶
 163   1      }
 164          //**************************************
 165          //I2Cå‘é€åº”ç­”ä¿¡å·
 166          //å…¥å£å‚æ•°:ack (0:ACK 1:NAK)
 167          //**************************************
 168          void I2C_SendACK(bit ack)
 169          {
 170   1          SDA = ack;                  //å†™åº”ç­”ä¿¡å·
 171   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 172   1          Delay5us();                 //å»¶æ—¶
 173   1          SCL = 0;                    //æ‹‰ä½æ—¶é’Ÿçº¿
 174   1          Delay5us();                 //å»¶æ—¶
 175   1      }
 176          //**************************************
 177          //I2Cæ¥æ”¶åº”ç­”ä¿¡å·
 178          //**************************************
C51 COMPILER V9.54   MPU6050                                                               03/13/2018 22:04:48 PAGE 4   

 179          bit I2C_RecvACK()
 180          {
 181   1          SCL = 1;                    //æ‹‰é«˜æ—¶é’Ÿçº¿
 182   1          Delay5us();                 //å»¶æ—¶
 183   1          CY = SDA;                   //è¯»åº”ç­”ä¿¡å·
 184   1          SCL = 0;                    //æ‹‰ä½æ—¶é’Ÿçº¿
 185   1          Delay5us();                 //å»¶æ—¶
 186   1          return CY;
 187   1      }
 188          //**************************************
 189          //å‘I2Cæ€»çº¿å‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®
 190          //**************************************
 191          void I2C_SendByte(uchar dat)
 192          {
 193   1          uchar i;
 194   1          for (i=0; i<8; i++)         //8ä½è®¡æ•°å™¨
 195   1          {
 196   2              dat <<= 1;              //ç§»å‡ºæ•°æ®çš„æœ€é«˜ä½
 197   2              SDA = CY;               //é€æ•°æ®å£
 198   2              SCL = 1;                //æ‹‰é«˜æ—¶é’Ÿçº¿
 199   2              Delay5us();             //å»¶æ—¶
 200   2              SCL = 0;                //æ‹‰ä½æ—¶é’Ÿçº¿
 201   2              Delay5us();             //å»¶æ—¶
 202   2          }
 203   1          I2C_RecvACK();
 204   1      }
 205          //**************************************
 206          //ä»I2Cæ€»çº¿æ¥æ”¶ä¸€ä¸ªå­—èŠ‚æ•°æ®
 207          //**************************************
 208          uchar I2C_RecvByte()
 209          {
 210   1          uchar i;
 211   1          uchar dat = 0;
 212   1          SDA = 1;                    //ä½¿èƒ½å†…éƒ¨ä¸Šæ‹‰,å‡†å¤‡è¯»å–æ•°æ®,
 213   1          for (i=0; i<8; i++)         //8ä½è®¡æ•°å™¨
 214   1          {
 215   2              dat <<= 1;
 216   2              SCL = 1;                //æ‹‰é«˜æ—¶é’Ÿçº¿
 217   2              Delay5us();             //å»¶æ—¶
 218   2              dat |= SDA;             //è¯»æ•°æ®
 219   2              SCL = 0;                //æ‹‰ä½æ—¶é’Ÿçº¿
 220   2              Delay5us();             //å»¶æ—¶
 221   2          }
 222   1          return dat;
 223   1      }
 224          //**************************************
 225          //å‘I2Cè®¾å¤‡å†™å…¥ä¸€ä¸ªå­—èŠ‚æ•°æ®
 226          //**************************************
 227          void Single_WriteI2C(uchar REG_Address,uchar REG_data)
 228          {
 229   1          I2C_Start();                  //èµ·å§‹ä¿¡å·
 230   1          I2C_SendByte(SlaveAddress);   //å‘é€è®¾å¤‡åœ°å€+å†™ä¿¡å·
 231   1          I2C_SendByte(REG_Address);    //å†…éƒ¨å¯„å­˜å™¨åœ°å€ï¼Œ
 232   1          I2C_SendByte(REG_data);       //å†…éƒ¨å¯„å­˜å™¨æ•°æ®ï¼Œ
 233   1          I2C_Stop();                   //å‘é€åœæ­¢ä¿¡å·
 234   1      }
 235          //**************************************
 236          //ä»I2Cè®¾å¤‡è¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®
 237          //**************************************
 238          uchar Single_ReadI2C(uchar REG_Address)
 239          {
 240   1        uchar REG_data;
C51 COMPILER V9.54   MPU6050                                                               03/13/2018 22:04:48 PAGE 5   

 241   1        I2C_Start();                   //èµ·å§‹ä¿¡å·
 242   1        I2C_SendByte(SlaveAddress);    //å‘é€è®¾å¤‡åœ°å€+å†™ä¿¡å·
 243   1        I2C_SendByte(REG_Address);     //å‘é€å­˜å‚¨å•å…ƒåœ°å€ï¼Œä»0å¼€å§‹
 244   1        I2C_Start();                   //èµ·å§‹ä¿¡å·
 245   1        I2C_SendByte(SlaveAddress+1);  //å‘é€è®¾å¤‡åœ°å€+è¯»ä¿¡å·
 246   1        REG_data=I2C_RecvByte();       //è¯»å‡ºå¯„å­˜å™¨æ•°æ®
 247   1        I2C_SendACK(1);                //æ¥æ”¶åº”ç­”ä¿¡å·
 248   1        I2C_Stop();                    //åœæ­¢ä¿¡å·
 249   1        return REG_data;
 250   1      }
 251          //**************************************
 252          //åˆå§‹åŒ–MPU6050
 253          //**************************************
 254          void InitMPU6050()
 255          {
 256   1        Single_WriteI2C(PWR_MGMT_1, 0x00);  //è§£é™¤ä¼‘çœ çŠ¶æ€
 257   1        Single_WriteI2C(SMPLRT_DIV, 0x07);
 258   1        Single_WriteI2C(CONFIG, 0x06);
 259   1        Single_WriteI2C(GYRO_CONFIG, 0x18);
 260   1        Single_WriteI2C(ACCEL_CONFIG, 0x01);
 261   1      }
 262          //**************************************
 263          //åˆæˆæ•°æ®
 264          //**************************************
 265          int GetData(uchar REG_Address)
 266          {
 267   1        uchar H,L;
 268   1        H=Single_ReadI2C(REG_Address);
 269   1        L=Single_ReadI2C(REG_Address+1);
 270   1        return (H<<8)+L;   //åˆæˆæ•°æ®
 271   1      }
 272          //**************************************
 273          //åœ¨1602ä¸Šæ˜¾ç¤º10ä½æ•°æ®
 274          //**************************************
 275          void Display10BitData(int value,uchar x,uchar y)
 276          {  uchar i;
 277   1      //  value/=64;              //è½¬æ¢ä¸º10ä½æ•°æ®
 278   1        lcd_printf(dis, value);     //è½¬æ¢æ•°æ®æ˜¾ç¤º
 279   1        for(i=0;i<6;i++)
 280   1        {
 281   2            SeriPushSend(dis[i]);
 282   2          }
 283   1      
 284   1        //  DisplayListChar(x,y,dis,4); //å¯å§‹åˆ—ï¼Œè¡Œï¼Œæ˜¾ç¤ºæ•°ç»„ï¼Œæ˜¾ç¤ºé•¿åº¦
 285   1      }
*** WARNING C280 IN LINE 275 OF MPU6050.c: 'x': unreferenced local variable
*** WARNING C280 IN LINE 275 OF MPU6050.c: 'y': unreferenced local variable
 286          //**************************************
 287          //æ˜¾ç¤ºæ¸©åº¦
 288          //**************************************
 289          //void display_temp()
 290          //{
 291          //  Temp_h=Single_ReadI2C(TEMP_OUT_H); //è¯»å–æ¸©åº¦
 292          //  Temp_l=Single_ReadI2C(TEMP_OUT_L); //è¯»å–æ¸©åº¦
 293          //  Temperature=Temp_h<<8|Temp_l;     //åˆæˆæ¸©åº¦
 294          //  Temperature = 35+ ((double) (Temperature + 13200)) / 280; // è®¡ç®—å‡ºæ¸©åº¦
 295          //  lcd_printf(dis,Temperature);     //è½¬æ¢æ•°æ®æ˜¾ç¤º
 296          //  DisplayListChar(11,1,dis,4);     //å¯å§‹åˆ—ï¼Œè¡Œï¼Œæ˜¾ç¤ºæ•°ç»„ï¼Œæ˜¾ç¤ºä½æ•°
 297          //}
 298          
 299          void init_uart()
 300          {
C51 COMPILER V9.54   MPU6050                                                               03/13/2018 22:04:48 PAGE 6   

 301   1        TMOD=0x21;
 302   1        TH1=0xfd;
 303   1        TL1=0xfd;
 304   1      
 305   1        SCON=0x50;
 306   1        PS=1;      //ä¸²å£ä¸­æ–­è®¾ä¸ºé«˜ä¼˜å…ˆçº§åˆ«
 307   1        TR0=1;     //å¯åŠ¨å®šæ—¶å™¨
 308   1        TR1=1;
 309   1        ET0=1;     //æ‰“å¼€å®šæ—¶å™¨0ä¸­æ–­
 310   1        ES=1;
 311   1        EA=1;
 312   1      }
 313          void SerilSendStr(uchar* str,uchar len) {
 314   1        uchar i = 0;
 315   1        for (i = 0; i < len; i++) {
 316   2          SeriPushSend(*(str+i));
 317   2        }
 318   1      }
 319          uchar checkckv(uchar* buff,uchar len)
 320          {
 321   1        uchar ret = 0x5a;
 322   1        uchar i = 0;
 323   1        for (i = 0; i < len; i++) {
 324   2          ret += *(buff+i)^ret;
 325   2        }
 326   1        return ret;
 327   1      }
 328          
 329          //*********************************************************
 330          //ä¸»ç¨‹åº
 331          //*********************************************************
 332          void main()
 333          {
 334   1        uchar sendbuff[200];
 335   1        uchar len,ckvlen;
 336   1        int tempdata;
 337   1        delay(500);   //ä¸Šç”µå»¶æ—¶
 338   1      //  InitLcd();    //æ¶²æ™¶åˆå§‹åŒ–
 339   1        init_uart();
 340   1        InitMPU6050();  //åˆå§‹åŒ–MPU6050
 341   1        delay(150);
 342   1        while(1)
 343   1        {
 344   2          len = 0;
 345   2          sendbuff[len++] = '$';
 346   2          sendbuff[len++] = 0x55;
 347   2          sendbuff[len++] = 0xaa;
 348   2          tempdata = GetData(ACCEL_XOUT_H);
 349   2          sendbuff[len++] = tempdata&0xff;
 350   2          sendbuff[len++] = (tempdata>>8)&0xff;
 351   2          sendbuff[len++] = (tempdata>>16)&0xff;
 352   2          sendbuff[len++] = (tempdata>>24)&0xff;
 353   2          tempdata = GetData(ACCEL_YOUT_H);
 354   2          sendbuff[len++] = tempdata&0xff;
 355   2          sendbuff[len++] = (tempdata>>8)&0xff;
 356   2          sendbuff[len++] = (tempdata>>16)&0xff;
 357   2          sendbuff[len++] = (tempdata>>24)&0xff;
 358   2          tempdata = GetData(ACCEL_ZOUT_H);
 359   2          sendbuff[len++] = tempdata&0xff;
 360   2          sendbuff[len++] = (tempdata>>8)&0xff;
 361   2          sendbuff[len++] = (tempdata>>16)&0xff;
 362   2          sendbuff[len++] = (tempdata>>24)&0xff;
C51 COMPILER V9.54   MPU6050                                                               03/13/2018 22:04:48 PAGE 7   

 363   2          tempdata = GetData(GYRO_XOUT_H);
 364   2          sendbuff[len++] = tempdata&0xff;
 365   2          sendbuff[len++] = (tempdata>>8)&0xff;
 366   2          sendbuff[len++] = (tempdata>>16)&0xff;
 367   2          sendbuff[len++] = (tempdata>>24)&0xff;
 368   2          tempdata = GetData(GYRO_YOUT_H);
 369   2          sendbuff[len++] = tempdata&0xff;
 370   2          sendbuff[len++] = (tempdata>>8)&0xff;
 371   2          sendbuff[len++] = (tempdata>>16)&0xff;
 372   2          sendbuff[len++] = (tempdata>>24)&0xff;
 373   2          tempdata = GetData(GYRO_ZOUT_H);
 374   2          sendbuff[len++] = tempdata&0xff;
 375   2          sendbuff[len++] = (tempdata>>8)&0xff;
 376   2          sendbuff[len++] = (tempdata>>16)&0xff;
 377   2          sendbuff[len++] = (tempdata>>24)&0xff;
 378   2          ckvlen = len;
 379   2          sendbuff[len++] = checkckv(sendbuff,ckvlen);
 380   2          sendbuff[len++] = 0x0d;
 381   2          sendbuff[len++] = 0x0a;
 382   2          SerilSendStr(sendbuff,len);
 383   2          delay(100);
 384   2        }
 385   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1778    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      8     218
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
