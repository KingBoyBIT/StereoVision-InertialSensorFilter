clear,clc,close all
load('stereo_pair_param.mat')

%% 初始化测试
param.dxl=1e-5;param.dyl=1e-5;
param.dxr=1e-5;param.dyr=1e-5;
param.fl=-10/1000;param.fr=-10/1000;

width = 640;height = 480;
param.ul=320;param.vl=240;
param.ur=320;param.vr=240;
param.ul0 = width/2;param.vl0 = height/2;
param.ur0 = width/2;param.vr0 = height/2;
param.tx = 50/1000;
param.ty = 0/1000;
param.tz = 0/1000;
param.Rc = angle2dcm(0,0,0);
% c11 = Rc(1,1);c12 = Rc(1,2);c13 = Rc(1,3);
% c21 = Rc(2,1);c22 = Rc(2,2);c23 = Rc(2,3);
% c31 = Rc(3,1);c32 = Rc(3,2);c33 = Rc(3,3);

out = camCoordinate(param);


%% 特征点位置影响对精度的影响
% 令特征位于两个相机的中心线处，距相机50mm-10m的距离变化
pos_real = [];
pos_err = [];
i = 1;
for delta = 30:290
	param.ul = width/2+delta;
	param.ur = width/2-delta;
	out = camCoordinate(param);
	pos_real(:,i) = out;
	noise = rand;
	param.ul = width/2+delta+noise;%一个像素的偏差
	param.ur = width/2-delta-noise;
	out = camCoordinate(param);
	pos_err(:,i) = out;
	i = i + 1;
end
figure
subplot(1,2,1)
plot(width/2+10:width/2+290,pos_real(3,:),'-r.',width/2+10:width/2+290,pos_err(3,:),'-b*')
xlabel('像素坐标')
ylabel('Z_c')
title('特征点')
subplot(1,2,2)
plot(width/2+10:width/2+290,pos_real(3,:)-pos_err(3,:),'-g*')
xlabel('像素坐标')
ylabel('Z_c')
%% 坐标函数
function out = camCoordinate(param)
dxl=param.dxl;dyl=param.dyl;
dxr=param.dxr;dyr=param.dyr;
fl=param.fl;fr=param.fr;

ul=param.ul;vl=param.vl;
ur=param.ur;vr=param.vr;
ul0 = param.ul0;vl0 = param.vl0;
ur0 = param.ur0;vr0 = param.vr0;
tx = param.tx;
ty = param.ty;
tz = param.tz;

c11 = param.Rc(1,1);c12 = param.Rc(1,2);c13 = param.Rc(1,3);
c21 = param.Rc(2,1);c22 = param.Rc(2,2);c23 = param.Rc(2,3);
c31 = param.Rc(3,1);c32 = param.Rc(3,2);c33 = param.Rc(3,3);


X_cl = (dxl*(ul - ul0)*( fr*tx - tz*dxr*( ur - ur0 ) ))/( c31*dxl*( ul - ul0 ) + c32*dyl*( vl - vl0 ) + fl*c33 )*dxr*( ur - ur0 ) - fr*( c11*dxl*( ul - ul0 ) + c12*dyl*( vl - vl0 ) + fl*c13 );
Y_cl = (dyl*(vl - vl0)*( fr*tx - tz*dxr*( ur - ur0 ) ))/( c31*dxl*( ul - ul0 ) + c32*dyl*( vl - vl0 ) + fl*c33 )*dxr*( ur - ur0 ) - fr*( c11*dxl*( ul - ul0 ) + c12*dyl*( vl - vl0 ) + fl*c13 );
Z_cl = (fl*( fr*tx - tz*dxr*( ur - ur0 ) ))/(( c31*dxl*( ul - ul0 ) + c32*dyl*( vl - vl0 ) + fl*c33 )*dxr*( ur - ur0 ) - fr*( c11*dxl*( ul - ul0 ) + c12*dyl*( vl - vl0 ) + fl*c13 ));
out = [X_cl;Y_cl;Z_cl];
end